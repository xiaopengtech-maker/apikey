<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>API Key Manager</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        form { margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; align-items: end; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; }
        .form-actions { display:flex; gap:8px; align-items:center; }
        button { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        button[type="submit"] { background-color: #007bff; color: white; }
        button[type="submit"]:hover { background-color: #0056b3; }
        #cancelBtn { background-color: #6c757d; color: white; }
        #cancelBtn:hover { background-color: #545b62; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        .actions button { margin-right: 5px; padding: 5px 10px; font-size: 12px; }
        .edit-btn { background-color: #ffc107; color: black; }
        .edit-btn:hover { background-color: #e0a800; }
        .delete-btn { background-color: #dc3545; color: white; }
        .delete-btn:hover { background-color: #c82333; }
        #checkForm { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; }
        #checkResult { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>API Key Manager</h1>

        <form id="keyForm">
            <div>
                <label>Key: <input type="text" id="keyInput" required></label>
            </div>
            <div>                <input type="hidden" id="editId">
            </div>
            <div>
                <label>Expiration:
                    <select id="expType" onchange="onExpTypeChange(this)">
                        <option value="permanent">Permanent</option>
                        <option value="1">1 day</option>
                        <option value="15">15 days</option>
                        <option value="30">30 days</option>
                        <option value="date">Custom date...</option>
                    </select>
                </label>
                <div id="expPreview" style="margin-top:6px;color:#666;font-size:13px;"></div>
            </div>
            <div>
                <input type="date" id="expDate" style="display: none;">
            </div> 
            <div>
                <button type="submit" id="submitBtn">Add Key</button>
                <button type="button" id="cancelBtn" style="display: none;" onclick="cancelEdit()">Cancel</button>
            </div>
        </form>

        <h2>Keys</h2>
        <table id="keysTable">
            <tr><th>ID</th><th>Key</th><th>Expiration</th><th>Actions</th></tr>
        </table>

        <h2>Check Key</h2>
        <form id="checkForm">
            <label>Key: <input type="text" id="checkKey" required></label>
            <button type="submit">Check</button>
        </form>
        <p id="checkResult"></p>

        <h2>API (test)</h2>
        <form id="apiTestForm">
            <label>Key: <input type="text" id="apiKey" required></label>
            <label>Expiration:
                <select id="apiExpType">
                    <option value="permanent">Permanent</option>
                    <option value="1">1 day</option>
                    <option value="15">15 days</option>
                    <option value="30">30 days</option>
                    <option value="date">Custom date...</option>
                </select>
            </label>
            <input type="date" id="apiExpDate" style="display:none;">
            <button type="submit">Send POST</button>
        </form>
        <pre id="apiResult" style="background:#f3f3f3;padding:10px;border-radius:6px;min-height:40px;"></pre>
    </div>

    <script>
        let keys = [];
        let nextId = 1;

        async function fetchKeys() {
            try {
                const res = await fetch('/api/keys');
                if (!res.ok) throw new Error('Network response not ok');
                keys = await res.json();
                nextId = keys.length ? Math.max(...keys.map(k => k.id)) + 1 : 1;
                renderTable();
                // keep localStorage in sync
                localStorage.setItem('keys', JSON.stringify(keys));
            } catch (err) {
                console.warn('API failed, falling back to localStorage', err);
                keys = JSON.parse(localStorage.getItem('keys')) || [];
                nextId = keys.length ? Math.max(...keys.map(k => k.id)) + 1 : 1;
                renderTable();
            }
        }

        function daysBetween(dateStr) {
            const today = new Date();
            const d = new Date(dateStr);
            today.setHours(0,0,0,0);
            d.setHours(0,0,0,0);
            const ms = d - today;
            return Math.round(ms / (1000*60*60*24));
        }

        function displayExpiration(exp) {
            if (exp === 'permanent') return 'Permanent';
            const days = daysBetween(exp);
            if (days > 0) return `${exp} (${days} day(s) left)`;
            if (days === 0) return `${exp} (expires today)`;
            return `${exp} (expired)`;
        }

        function renderTable() {
            let html = '<tr><th>ID</th><th>Key</th><th>Expiration</th><th>Actions</th></tr>';
            keys.forEach(key => {
                html += `<tr>
                    <td>${key.id}</td>
                    <td>${key.key}</td>
                    <td>${displayExpiration(key.expiration)}</td>
                    <td>
                        <button class="edit-btn" onclick="editKey(${key.id})">Edit</button>
                        <button class="delete-btn" onclick="deleteKey(${key.id})">Delete</button>
                    </td>
                </tr>`;
            });
            document.getElementById('keysTable').innerHTML = html;
            localStorage.setItem('keys', JSON.stringify(keys));
        }

        function toggleDate(sel) {
            if (!sel) sel = document.getElementById('expType');
            const expDate = document.getElementById('expDate');
            if (sel.value === 'date') {
                expDate.style.display = 'inline';
                expDate.required = true;
            } else {
                expDate.style.display = 'none';
                expDate.required = false;
            }
            updateExpPreview(sel);
        }

        function onExpTypeChange(sel) {
            toggleDate(sel);
            updateExpPreview(sel);
        }

        function computeExpirationFromType(expType, dateElId='expDate') {
            if (expType === 'permanent') return 'permanent';
            if (expType === 'date') return document.getElementById(dateElId).value;
            const days = parseInt(expType, 10);
            const d = new Date();
            d.setDate(d.getDate() + days);
            return d.toISOString().slice(0,10);
        }

        function updateExpPreview(sel) {
            if (!sel) sel = document.getElementById('expType');
            const preview = document.getElementById('expPreview');
            if (!preview) return;
            if (sel.value === 'permanent') {
                preview.textContent = '';
            } else if (sel.value === 'date') {
                const v = document.getElementById('expDate').value;
                preview.textContent = v ? `Expires on ${v}` : 'Choose a date';
            } else {
                const expiration = computeExpirationFromType(sel.value);
                preview.textContent = `Expires on ${expiration}`;
            }
        }

        // API utilities
        async function createKeyAPI(payload) {
            const res = await fetch('/api/keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Create failed');
            return res.json();
        }
        async function updateKeyAPI(payload) {
            const res = await fetch('/api/keys', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Update failed');
            return res.json();
        }
        async function deleteKeyAPI(id) {
            const res = await fetch('/api/keys', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            if (!res.ok) throw new Error('Delete failed');
            return res.json();
        }

        document.getElementById('expDate').addEventListener('input', function() {
            updateExpPreview(document.getElementById('expType'));
        });

        // API test form show/hide date
        document.getElementById('apiExpType').addEventListener('change', function() {
            const d = document.getElementById('apiExpDate');
            if (this.value === 'date') { d.style.display = 'inline'; d.required = true; }
            else { d.style.display = 'none'; d.required = false; }
        });

        document.getElementById('apiTestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const key = document.getElementById('apiKey').value;
            const expType = document.getElementById('apiExpType').value;
            const expDate = document.getElementById('apiExpDate').value;
            const payload = { key };
            if (expType === 'date') payload.expiration = expDate; else payload.expType = expType;
            try {
                const result = await createKeyAPI(payload);
                document.getElementById('apiResult').textContent = JSON.stringify(result, null, 2);
                await fetchKeys();
            } catch (err) {
                document.getElementById('apiResult').textContent = 'Error: ' + err.message;
            }
        });

        document.getElementById('keyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const keyVal = document.getElementById('keyInput').value;
            const expType = document.getElementById('expType').value;
            const expiration = computeExpirationFromType(expType);

            try {
                if (id) {
                    await updateKeyAPI({ id: parseInt(id), key: keyVal, expiration });
                } else {
                    await createKeyAPI({ key: keyVal, expiration });
                }
                await fetchKeys();
                this.reset();
                document.getElementById('editId').value = '';
                document.getElementById('submitBtn').textContent = 'Add Key';
                document.getElementById('cancelBtn').style.display = 'none';
                updateExpPreview(document.getElementById('expType'));
            } catch (err) {
                alert('API error: ' + err.message);
            }
        });

        async function editKey(id) {
            const key = keys.find(k => k.id == id);
            document.getElementById('editId').value = id;
            document.getElementById('keyInput').value = key.key;
            const expTypeEl = document.getElementById('expType');
            if (key.expiration === 'permanent') {
                expTypeEl.value = 'permanent';
            } else {
                const diff = daysBetween(key.expiration);
                if (diff === 1 || diff === 15 || diff === 30) {
                    expTypeEl.value = String(diff);
                    document.getElementById('expDate').value = '';
                } else {
                    expTypeEl.value = 'date';
                    document.getElementById('expDate').value = key.expiration;
                }
            }
            toggleDate(expTypeEl);
            updateExpPreview(expTypeEl);
            document.getElementById('submitBtn').textContent = 'Update Key';
            document.getElementById('cancelBtn').style.display = 'inline';
        }

        async function deleteKey(id) {
            if (confirm('Delete key?')) {
                try {
                    await deleteKeyAPI(id);
                    await fetchKeys();
                } catch (err) {
                    alert('Delete failed: ' + err.message);
                }
            }
        }

        document.getElementById('checkForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const checkKey = document.getElementById('checkKey').value;
            const result = document.getElementById('checkResult');
            const key = keys.find(k => k.key === checkKey);
            if (!key) {
                result.textContent = 'Key not found.';
                return;
            }
            if (key.expiration === 'permanent') {
                result.textContent = 'Key is valid (permanent).';
            } else if (new Date(key.expiration) > new Date()) {
                result.textContent = 'Key is valid.';
            } else {
                result.textContent = 'Key has expired.';
            }
        });

        fetchKeys();
    </script>
</body>
</html>
